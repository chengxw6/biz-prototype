<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•æ”¯ä»˜ - ä¸šåŠ¡ä¸‹å•ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">ä¸šåŠ¡ä¸‹å•ç³»ç»Ÿ</div>
            <ul class="sidebar-nav">
                <li><a href="products.html">ç”³è¯·æ–°è¯ä¹¦</a></li>
                <li><a href="list.html">æˆ‘çš„è®¢å•</a></li>
                <li><a href="../certificate/list.html">æˆ‘çš„è¯ä¹¦</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="user-menu">
                    <button class="user-menu-button" id="userMenuButton">
                        <span>ä¸ªäººè´¦æˆ·: Cheng Xiuwen</span>
                        <i class="arrow"></i>
                    </button>
                    <div class="user-menu-dropdown" id="userMenuDropdown">
                        <div class="dropdown-header">åˆ‡æ¢è´¦æˆ·</div>
                        <a href="#" class="dropdown-item active" data-account-type="personal" data-account-name="Cheng Xiuwen">âœ“ ä¸ªäººè´¦æˆ·: Cheng Xiuwen</a>
                        <a href="#" class="dropdown-item" data-account-type="org" data-account-name="GDCA Co., Ltd.">æœºæ„è´¦æˆ·: GDCA Co., Ltd.</a>
                        <div class="dropdown-divider"></div>
                        <a href="../account/profile.html" class="dropdown-item">è´¦æˆ·ä¿¡æ¯ä¿®æ”¹</a>
                        <a href="../account/login.html" class="dropdown-item">é€€å‡ºç™»å½•</a>
                    </div>
                </div>
            </header>

            <div class="page-header">
                <h1>è®¢å•æ”¯ä»˜</h1>
            </div>

            <div class="payment-process">
                <div class="process-steps">
                    <div class="step completed">
                        <div class="step-number">1</div>
                        <div class="step-name">ç¡®è®¤è®¢å•</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step active">
                        <div class="step-number">2</div>
                        <div class="step-name">æ”¯ä»˜</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-name">å®Œæˆ</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">è®¢å•æ‘˜è¦</div>
                <div class="card-body">
                    <table class="order-summary-table">
                        <thead>
                            <tr>
                                <th>äº§å“åç§°</th>
                                <th>å•ä»·</th>
                                <th>æ•°é‡</th>
                                <th>å°è®¡</th>
                            </tr>
                        </thead>
                        <tbody id="orderItems">
                            <!-- è®¢å•é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-right"><strong>æ€»è®¡ï¼š</strong></td>
                                <td id="orderTotal" class="total-price">HK$0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">æ”¯ä»˜æ–¹å¼</div>
                <div class="card-body">
                    <div class="payment-methods">
                        <div class="payment-method">
                            <input type="radio" name="payment_method" id="credit_card" value="credit_card" checked>
                            <label for="credit_card">
                                <div class="payment-logo">ğŸ’³</div>
                                <div class="payment-name">ä¿¡ç”¨å¡æ”¯ä»˜</div>
                            </label>
                        </div>
                        <div class="payment-method">
                            <input type="radio" name="payment_method" id="alipay" value="alipay">
                            <label for="alipay">
                                <div class="payment-logo">ğŸ’°</div>
                                <div class="payment-name">æ”¯ä»˜å®</div>
                            </label>
                        </div>
                        <div class="payment-method">
                            <input type="radio" name="payment_method" id="wechat" value="wechat">
                            <label for="wechat">
                                <div class="payment-logo">ğŸ’š</div>
                                <div class="payment-name">å¾®ä¿¡æ”¯ä»˜</div>
                            </label>
                        </div>
                    </div>

                    <div id="credit_card_form" class="payment-form">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="card_number">å¡å· <span class="required">*</span></label>
                                <input type="text" id="card_number" placeholder="1234 5678 9012 3456" required>
                            </div>
                            <div class="form-group">
                                <label for="expiry_date">æœ‰æ•ˆæœŸ <span class="required">*</span></label>
                                <input type="text" id="expiry_date" placeholder="MM/YY" required>
                            </div>
                            <div class="form-group">
                                <label for="cvv">å®‰å…¨ç  <span class="required">*</span></label>
                                <input type="text" id="cvv" placeholder="123" required>
                            </div>
                            <div class="form-group full-width">
                                <label for="card_holder">æŒå¡äººå§“å <span class="required">*</span></label>
                                <input type="text" id="card_holder" placeholder="æŒå¡äººå§“å" required>
                            </div>
                        </div>
                    </div>

                    <div id="alipay_form" class="payment-form hidden">
                        <p class="payment-instruction">ç‚¹å‡»"ç¡®è®¤æ”¯ä»˜"åï¼Œå°†ç”Ÿæˆæ”¯ä»˜å®ä»˜æ¬¾äºŒç»´ç </p>
                    </div>

                    <div id="wechat_form" class="payment-form hidden">
                        <p class="payment-instruction">ç‚¹å‡»"ç¡®è®¤æ”¯ä»˜"åï¼Œå°†ç”Ÿæˆå¾®ä¿¡æ”¯ä»˜äºŒç»´ç </p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">å‘ç¥¨ä¿¡æ¯</div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="invoice_type">å‘ç¥¨ç±»å‹</label>
                        <select id="invoice_type">
                            <option value="electronic">ç”µå­å‘ç¥¨</option>
                            <option value="paper">çº¸è´¨å‘ç¥¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="invoice_title">å‘ç¥¨æŠ¬å¤´</label>
                        <input type="text" id="invoice_title" placeholder="ä¸ªäºº/å…¬å¸åç§°">
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <a href="confirm.html" class="btn btn-secondary">è¿”å›ä¿®æ”¹</a>
                <button id="submitPayment" class="btn btn-primary">ç¡®è®¤æ”¯ä»˜</button>
            </div>
        </main>
    </div>

    <!-- æ”¯ä»˜æˆåŠŸæ¨¡æ€æ¡† -->
    <div id="paymentSuccessModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ”¯ä»˜æˆåŠŸ</h2>
            </div>
            <div class="modal-body">
                <div class="success-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
                        stroke="#28a745" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                </div>
                <p>æ‚¨çš„è®¢å•å·²æ”¯ä»˜æˆåŠŸï¼</p>
                <p>è®¢å•å·: <span id="orderNumber"></span></p>
                <p>è¯·å‰å¾€"æˆ‘çš„è¯ä¹¦"é¡µé¢å®Œå–„è¯ä¹¦ç”³è¯·ä¿¡æ¯ã€‚</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="confirmPaymentBtn">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script src="../assets/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Payment page loaded');
            
            // ä»sessionStorageè·å–è®¢å•ä¿¡æ¯
            const orderInfoJson = sessionStorage.getItem('orderInfo');
            console.log('è¯»å–åˆ°çš„è®¢å•ä¿¡æ¯:', orderInfoJson);

            // å¦‚æœæ²¡æœ‰è®¢å•ä¿¡æ¯ï¼Œåˆ›å»ºæµ‹è¯•æ•°æ®æˆ–é‡å®šå‘
            let orderInfo;
            if (!orderInfoJson) {
                console.log('æ²¡æœ‰æ‰¾åˆ°è®¢å•ä¿¡æ¯ï¼Œä½¿ç”¨æµ‹è¯•æ•°æ®');
                // åˆ›å»ºæµ‹è¯•è®¢å•ä¿¡æ¯
                orderInfo = {
                    items: [
                        {
                            id: 'personal-1234567890',
                            name: 'é›»å­è­‰æ›¸ï¼ˆå€‹äººï¼‰ (1å¹´ - HK$50)',
                            price: 50,
                            quantity: 1
                        },
                        {
                            id: 'ssl-dv-example.com-1234567892',
                            name: 'SSLè¯ä¹¦ (DVè¯ä¹¦; åŸŸå: example.com; 1å¹´)',
                            price: 500,
                            quantity: 1
                        }
                    ],
                    totalPrice: 550
                };
            } else {
                orderInfo = JSON.parse(orderInfoJson);
            }

            const cartItems = orderInfo.items;
            const totalPrice = orderInfo.totalPrice;

            // æ¸²æŸ“è®¢å•é¡¹
            const orderItemsContainer = document.getElementById('orderItems');
            const orderTotalElement = document.getElementById('orderTotal');

            cartItems.forEach(item => {
                const itemTotal = item.price * item.quantity;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>HK$${item.price.toFixed(0)}</td>
                    <td>${item.quantity}</td>
                    <td>HK$${itemTotal.toFixed(0)}</td>
                `;
                orderItemsContainer.appendChild(row);
            });

            // æ›´æ–°æ€»ä»·
            orderTotalElement.textContent = `HK$${totalPrice.toFixed(0)}`;

            // æ”¯ä»˜æ–¹å¼åˆ‡æ¢
            const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
            const paymentForms = document.querySelectorAll('.payment-form');

            paymentMethods.forEach(method => {
                method.addEventListener('change', function () {
                    paymentForms.forEach(form => form.classList.add('hidden'));
                    document.getElementById(`${this.value}_form`).classList.remove('hidden');
                });
            });

            // æ”¯ä»˜æˆåŠŸæ¨¡æ€æ¡†ç›¸å…³å…ƒç´ 
            const paymentSuccessModal = document.getElementById('paymentSuccessModal');
            const orderNumberElement = document.getElementById('orderNumber');
            const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');

            // æäº¤æ”¯ä»˜æŒ‰é’®
            const submitPaymentBtn = document.getElementById('submitPayment');

            submitPaymentBtn.addEventListener('click', function () {
                console.log('Submit payment button clicked');
                
                // éªŒè¯æ”¯ä»˜ä¿¡æ¯
                const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;

                if (paymentMethod === 'credit_card') {
                    const cardNumber = document.getElementById('card_number').value.trim();
                    const expiryDate = document.getElementById('expiry_date').value.trim();
                    const cvv = document.getElementById('cvv').value.trim();
                    const cardHolder = document.getElementById('card_holder').value.trim();

                    if (!cardNumber || !expiryDate || !cvv || !cardHolder) {
                        alert('è¯·å¡«å†™å®Œæ•´çš„ä¿¡ç”¨å¡ä¿¡æ¯');
                        return;
                    }
                }

                // æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†
                submitPaymentBtn.disabled = true;
                submitPaymentBtn.textContent = 'å¤„ç†ä¸­...';

                setTimeout(() => {
                    console.log('Payment processing completed');
                    
                    // ç”Ÿæˆéšæœºè®¢å•å·
                    const orderNumber = 'ORD-' + Date.now().toString().slice(-8) + '-' + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                    orderNumberElement.textContent = orderNumber;

                    // æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸæ¨¡æ€æ¡†
                    paymentSuccessModal.style.display = 'block';
                    console.log('Payment success modal displayed');

                    // æ¸…ç©ºè´­ç‰©è½¦å’Œè®¢å•æ•°æ®
                    sessionStorage.removeItem('cartItems');
                    sessionStorage.removeItem('orderInfo');
                }, 1500);
            });

            // ç¡®å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶ - è·³è½¬åˆ°"æˆ‘çš„è¯ä¹¦"é¡µé¢
            confirmPaymentBtn.addEventListener('click', function () {
                console.log('Confirm button clicked, redirecting to certificate list');
                paymentSuccessModal.style.display = 'none';
                window.location.href = '../certificate/list.html';
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­ï¼ˆå¯é€‰ï¼‰
            window.addEventListener('click', function (event) {
                if (event.target === paymentSuccessModal) {
                    console.log('Modal overlay clicked, redirecting to certificate list');
                    paymentSuccessModal.style.display = 'none';
                    window.location.href = '../certificate/list.html';
                }
            });
        });
    </script>
</body>

</html>